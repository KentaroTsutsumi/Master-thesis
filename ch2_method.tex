\include{preamble}
\include{begin}
%
% Contents
%
\chapter{Theory and Method}
%
% introかも...
%
%\section{Formulation of Density Functional Theory for Superconductors}
%Since BCS theory was established and electron-phonon interaction was found to be the
%superconducting pairing interaction, there were 
%\\
%
% introかも...
%
In order to calculate $T_\mathrm{c}$ from first-principles, 
L\"{u}ders and his co-workers constructed the density functional theory 
for superconductors (SCDFT)\cite{Luders2005_1}.
By using SCDFT, it is able to calculate $T_\mathrm{c}$ from {\it ab-initio} electronic wave functions
 and electron-phonon matrix elements and so on. 
First, we will review their theory including electron-phonon interaction and Coulomb interaction. 
After that, we will review how to include the effect of spin fluctuations into the SCDFT.

\section{Density functionals and Kohn-Sham system for superconductors}
In order to treat the electron-phonon and Coulomb interactions in superconductors like the Hohenberg-Kohn way, 
we consider the many-body electron-nuclear Hamiltonian
%
\begin{equation}  %%%%%%% Hamiltonian
\label{eq:Hamil}
   \hat{H} = \hat{T}^\mathrm{e} + \hat{T}^\mathrm{n} + \hat{U}^\mathrm{en} + \hat{U}^\mathrm{ee}
                   + \hat{V}^\mathrm{e}_\mathrm{ext} + \hat{V}^\mathrm{n}_\mathrm{ext}
                   + \hat{\Delta}_\mathrm{ext} - \mu\hat{N},
\end{equation} 
%
where $\hat{T}^\mathrm{e}$ represents the electronic kinetic energy, $\hat{T}^\mathrm{n}$ the nuclear kinetic energy, 
$\hat{U}^\mathrm{en}$ the electron-nuclear interaction, $\hat{U}^\mathrm{ee}$ the electron-electron interaction.
The electronic external potential $\hat{V}^\mathrm{e}_\mathrm{ext}$ is defined as
%
\begin{equation} %%%%%%% electronic external potential
	\hat{V}^\mathrm{e}_\mathrm{ext} = \sum_{\sigma}\int d^3r\hat{\Psi}^\dag_{\sigma}({\bm r})
	                                                            v^\mathrm{e}_{\rm ext}(\bm{r})\hat{\Psi}_{\sigma}(\bm{r}), 
\end{equation} 
%
where $\hat{\Psi}^\dag_{\sigma}({\bm r})$ is the electron creation operator. 
$\hat{V}^\mathrm{n}_\mathrm{ext}$  is a $N$-body operator with respect to the nuclear coordinates
%
\begin{equation} %%%%%%% nuclear external potential
	\hat{V}^\mathrm{n}_\mathrm{ext} = \sum_{\sigma}\int d^3\underline{\bm{R}}
	                                                            v^\mathrm{n}_\mathrm{ext}(\underline{\bm{R}})
	                                                            \hat{\Gamma}(\underline{\bm{R}}),
\end{equation} 
%
where $\underline{\bm{R}}$ represents a set of the coordinates of $N$-body nuclei and 
%
\begin{equation} %%%%%%% nuclear density distribution
	\hat{\Gamma}(\underline{\bm{R}}) = \hat{\Phi}^\dag \left(\bm{R}_1 \right) \cdots \hat{\Phi}^\dag \left(\bm{R}_N \right)
	                                                          \hat{\Phi} \left(\bm{R}_N \right) \cdots \hat{\Phi} \left(\bm{R}_1 \right)
\end{equation} 
%
is the $N$-body nuclear density matrix operator in which nuclear creation and annihilation operators 
$\hat{\Phi}^\dag$ and $\hat{\Phi}$ are used. The term
%
\begin{equation} %%%%%%% external pairing potential
	\hat{\Delta}_\mathrm{ext} = - \int d^3r \int d^3r' \left[\Delta^{\ast}_\mathrm{ext}(\bm{r}, \bm{r'})
	                                                                            \hat{\Psi}_\uparrow(\bm{r})\hat{\Psi}_\downarrow(\bm{r'})
	                                                                            + \rm{H.c.} \right].
\end{equation} 
%
indicates the external pairing field. This term must be included in order to break the gauge invariance of
the Hamiltonian. We will take the limit $\Delta_\mathrm{ext} \to 0$ at the end of the derivation.
In this thesis, it is assumed that we treat singlet superconductors. However,  we can extend the formulation 
for triplet superconductors straightforwardly.
Finally, $\mu$ means the chemical potential and $\hat{N}$ is the number operator of electrons. 

The formulation of this theory is based on three densities: (i) The usual electronic density 
%
\begin{equation} %%%%%%%  electronic density
	n\left(\bm{r}\right) = \sum_{\sigma}\left<\hat{\Psi}^\dag_\sigma \left(\bm{r}\right)
	                                                               \hat{\Psi}_\sigma \left(\bm{r}\right) \right>.
\end{equation}
%
The bracket indicates the thermal average
%
\begin{equation}
\begin{split}
	\left< \hat{A} \right> = {\rm Tr}\hat{\rho}_0\hat{A}, \\
	\hat{\rho}_0 = \frac{e^{-\beta\hat{H}}}{{\rm Tr}e^{-\beta\hat{H}}},
\end{split}
\end{equation}
%
where $\hat{\rho}_0$ is the grand canonical density operator and $\beta$ is the inverse temperature.

(ii) The anomalous density
%
\begin{equation} %%%%%%%  anomalous density
	\chi \bigl(\bm{r}, \bm{r'} \bigr) = \left<\hat{\Psi}^\dag_\uparrow \bigl(\bm{r}\bigr)
	                                                    \hat{\Psi}_\downarrow \bigl(\bm{r'}\bigr) \right>
\end{equation}
%
is the order parameter for the singlet superconductors. This quantity becomes zero above the $T_\mathrm{c}$ and finite below it.

(iii) The diagonal part of nuclear $N$-body density matrix
%
\begin{equation} %%%%%%% diagonal part of nuclear density matrix
	\Gamma(\underline{\bm{R}}) = \left<\hat{\Gamma}(\underline{\bm{R}}) \right>
\end{equation}
%
is introduced to describe the nuclear degrees of freedom.

Extending the Hohenberg-Kohn theorem in usual DFT for present multicomponent theory straightforwardly, 
the existence of one-to-one mapping between the set of the densities $ \left\{ n(\bm{r}), \chi \bigl(\bm{r}, \bm{r'} \bigr), 
\Gamma(\underline{\bm{R}}) \right\}$ and a set of the corresponding potentials 
$ \left\{ v^{\rm e}_{\rm ext}(\bm{r}), \Delta_\mathrm{ext}(\bm{r}, \bm{r'}), v^{\rm n}_{\rm ext}(\underline{\bm{R}}) \right\}$
is guaranteed.
Consequently, all observable quantities are functionals of these densities. 
This fact guarantees that the grand canonical potential 
%
\begin{equation}  %%%%%% grand canonical potential
\begin{split}
	\label{eq:grand_pot}
	\Omega[n, \chi, \Gamma] &= F[n, \chi, \Gamma] + \int d^3r n(\bm{r})[v^{\rm e}_{\rm ext}(\bm{r}) - \mu] \\
	                                    &\quad- \int d^3r \int d^3r' \left[\chi \bigl(\bm{r}, \bm{r'} \bigr)
	                                       \Delta^{\ast}_\mathrm{ext}(\bm{r}, \bm{r'}) + {\rm H.c.} \right]\\
	                     &\quad+ \int d^3\underline{R} \Gamma(\underline{\bm{R}})v^{\rm n}_{\rm ext}(\underline{\bm{R}})
\end{split}
\end{equation}
%
is minimized by the ground state densities. The notation $A[f]$ means that $A$ is a functional of $f$.
The functional $F$ is defined as
%
\begin{equation} %%%%%%% Free energy of interacting system
\label{eq:Free_int}
\begin{split}
	F[n, \chi, \Gamma] &= T^{\rm e}[n, \chi, \Gamma] + T^{\rm n}[n, \chi, \Gamma] + U^{\rm en}[n, \chi, \Gamma] \\
	                                  &\quad + U^{\rm ee}[n, \chi, \Gamma] - \frac{1}{\beta}S[n, \chi, \Gamma],
\end{split}
\end{equation}
%
where $S$ represents the entropy of the system
%
\begin{equation}
	S[n, \chi, \Gamma] = -{\rm Tr}\left\{\hat{\rho}_0 [n, \chi, \Gamma]{\rm ln}\hat{\rho}_0 [n, \chi, \Gamma] \right\}.
\end{equation}
%

In this formulation, the Kohn-Sham system consists of noninteracting electrons and {\it interacting} nuclei. 
By including the interacting nuclei, we can treat lattice dynamics.
%The difference from the usual DFT is the fact that we include the nuclei.
The thermodynamic potential of the Kohn-Sham system is described as
%
\begin{equation} %%%%%% grand potential of the Kohn-Sham system
\label{eq:grand_pot_KS}
\begin{split}
	\Omega_0[n, \chi, \Gamma] &= F_0[n, \chi, \Gamma] + \int d^3r n(\bm{r}) \left[v^{\rm e}_0(\bm{r})-\mu_0 \right] \\
						&\quad \int d^3r \int d^3r' \left[\chi \bigl(\bm{r}, \bm{r'} \bigr)
	                                       \Delta^{\ast}_0(\bm{r}, \bm{r'}) + {\rm H.c.} \right]\\
	                   &\quad+ \int d^3\underline{R} \Gamma(\underline{\bm{R}})v^{\rm n}_0(\underline{\bm{R}}),
\end{split}
\end{equation}
%
where $v^{\mathrm n}_0(\bm{r}), \Delta_0(\bm{r}, \bm{r'}),$ and $\Gamma(\underline{\bm{R}})$ are the 
Kohn-Sham potentials and $F_0$ is the counterpart of (\ref{eq:Free_int}) for the Kohn-Sham system, defined as
%
\begin{equation} %%%%%%% Free energy of Kohn-Sham system
\begin{split}
	F_0[n, \chi, \Gamma] &= T^{\rm e}_0[n, \chi, \Gamma] + T^{\rm n}_0[n, \chi, \Gamma] \\
	                                     &\quad - \frac{1}{\beta}S_0[n, \chi, \Gamma].
\end{split}
\end{equation}
%
Here $T^{\rm e}_0[n, \chi, \Gamma], T^{\rm n}_0[n, \chi, \Gamma],$ and $S_0[n, \chi, \Gamma]$ 
represents the electronic and nuclear kinetic energy and the entropy of the Kohn-Sham system, respectively.
%

The exchange-correlation free energy is defined as
%
\begin{equation}%%%%% ex-ch free energy functional 
\begin{split}
	\label{eq:Fxc-def}
	F_{\mathrm {xc}}[n, \chi, \Gamma] &= F[n, \chi, \Gamma] - F_0[n, \chi, \Gamma] - U^{\rm nn}[\Gamma] \\
							&\quad - E^{\rm ee}_{\rm H}[n, \chi, \Gamma] - E^{\rm en}_{\rm H}[n, \chi, \Gamma],
\end{split}
\end{equation}
%
where the Hartree terms are defined as
%
\begin{equation}%%%%% nuclear Hartree
	U^{\rm nn}[\Gamma] = \sum_{\alpha \neq \beta}\int d^3\underline{\bm{R}}\Gamma({\underline{\bm{R}}})
						\frac{Z^2}{\left| \bm{R}_\alpha - \bm{R}_\beta \right|},
\end{equation}
%
\begin{equation}%%%%% anomalous Hartree
	\label{eq:anomHartree}
	E^{\rm ee}_{\rm H}[n, \chi, \Gamma] = \frac{1}{2}\int d^3r\int d^3r' \frac{n(\bm{r})n(\bm{r'})}{|\bm{r}-\bm{r'}|}
								+ \int d^3r\int d^3r' \frac{|\chi(\bm{r}, \bm{r'})|^2}{|\bm{r}-\bm{r'}|},
\end{equation}
%
\begin{equation}%%%%% el-nuclear Hartree
	E^{\rm en}_{\rm H}[n, \chi, \Gamma] = -Z\sum_{\alpha} \int d^3r \int d^3\underline{\bm{R}} 
								\frac{n(\bm{r})\Gamma(\underline{\bm{R}})}{|\bm{r}-\bm{R}_\alpha|}.
\end{equation}
%
Then we obtain the Kohn-Sham potentials 
%
\begin{equation} %%%%% Kohn-Sham potential for electron
\begin{split}
	v^{\rm e}_0[n, \chi, \Gamma]({\bm r}) &= -Z\sum_{\alpha} \int d^3 \underline{\bm{R}}
									\frac{\Gamma(\underline{\bm{R}})}{|\bm{r}-\bm{R}_\alpha |} 
				+ \int d^3 r' \frac{n(\bm{r'})}{|\bm{r}-\bm{r'}|} \\
				& \quad + v^{\rm e}_{\rm xc}[n, \chi, \Gamma]({\bm r}),
\end{split}
\end{equation}
%
\begin{equation} %%%%% anomalous Kohn-Sham potential
\label{eq:Delta0}
\begin{split}
	\Delta_0[n, \chi, \Gamma]({\bm r}, {\bm r'}) = -\frac{\chi(\bm{r}, \bm{r'})}{|\bm{r}-\bm{r'}|}
									 + \Delta_{\rm xc}[n, \chi, \Gamma]({\bm r}, {\bm r'}),
\end{split}
\end{equation}
%
\begin{equation} %%%%% nuclear potential
\begin{split}
	v^{\rm n}_0[n, \chi, \Gamma](\underline{\bm{R}}) &= \sum_{\alpha \neq \beta}
											\frac{Z^2}{|\bm{R}_\alpha - \bm{R}_\beta|}
										- Z\sum_{\alpha} \int d^3r \frac{n(\bm{r})}{|\bm{r} - \bm{R}_\alpha|} \\
										&\quad + v^{\rm n}_{\rm xc}[n, \chi, \Gamma](\underline{\bm{R}}),
\end{split}
\end{equation}
%
where exchange-correlation potentials are defined as 
%
\begin{equation}
	v^{\rm e}_{\rm xc}[n, \chi, \Gamma]({\bm r}) = \frac{\delta F_{\rm xc}[n, \chi, \Gamma]}{\delta n({\bm r})},
\end{equation}
%
\begin{equation}
	\Delta_{\rm xc}[n, \chi, \Gamma]({\bm r}, {\bm r'}) = - \frac{\delta F_{\rm xc}[n, \chi, \Gamma]}
							    {\delta \chi({\bm r}, {\bm r'})},
	\label{eq:Deltaxc}
\end{equation}
%
\begin{equation}
	v^{\rm e}_{\rm xc}[n, \chi, \Gamma](\underline{\bm{R}}) = \frac{\delta F_{\rm xc}[n, \chi, \Gamma]}
												{\delta \Gamma(\underline{\bm R})}.
\end{equation}
%
These definitions are analogous to the definition in the standard DFT.
%
%
\section{The Kohn-Sham equations}
%
We introduced the Kohn-Sham states in the previous section. 
Now the problem of minimizing the grand canonical potential (\ref{eq:grand_pot_KS}) can be solved by
solving a set of three differential equations self-consistently.
Two of them describe the electronic degrees of freedom and the third desctibes the nuclear degrees of freedom.
%

The two coupled equations are as follows:
%
\begin{equation}
	\left[-\frac{\nabla^2}{2} + v^{\rm e}_0(\bm{r}) - \mu \right]u_n(\bm{r}) +
	\int d^3r'\Delta_0(\bm{r},\bm{r'})v_n({r'}) = \widetilde{E}_n u_n(\bm{r}),
	\label{eq:KS-BdG-par}
\end{equation}
%
\begin{equation}
	-\left[-\frac{\nabla^2}{2} + v^{\rm e}_0(\bm{r}) - \mu \right]v_n(\bm{r}) +
	\int d^3r'\Delta^{\ast}_0(\bm{r},\bm{r'})u_n({r'}) = \widetilde{E}_n v_n(\bm{r}),
	\label{eq:KS-BdG-hole}
\end{equation}
%
where $u_n(\bm{r})$ and $v_n(\bm{r})$ are particle and hole wavefunctions respectively.
These equations are equivalent to the Bogoliubov-de Gennes equations\cite{BdG1958}. %%% must cite!!
The equation for the nucleus 
%
\begin{equation}
	\left[-\sum_{\alpha}\frac{\nabla^2_\alpha}{2M} + v^{\rm n}_0(\underline{\bm{R}}) \right]
	\Phi_n(\underline{\bm{R}}) = {\mathcal E}_n\Phi_n(\underline{\bm{R}})
	\label{eq:BO-approx}
\end{equation}
%
where $\Phi_n(\underline{\bm{R}})$ is many-body nuclear wavefunction has the same structure as 
the usual nuclear Born-Oppenheimer equation.
%

In priciple, when we solve the equations (\ref{eq:KS-BdG-par})-(\ref{eq:BO-approx}) iteratively, 
we can obtain the ground state densities $\{n, \chi, \Gamma\}$.
However, it requires extraordinary high accuracy to resolve the superconducting energy gap
because the magnitude of it is about $10^{-3}$ \verb|~| $10^{-4}$ times typical electronic energy.
In order to avoid this difficulty, so-called ``decoupling approximation'' is beneficial.

In the decoupling approximation, we approximate the particle and hole one-particle wavefunctions as follows
%
\begin{equation}
	u_n(\bm{r}) \approx u_n\varphi_n(\bm{r}),   v_n(\bm{r}) \approx v_n\varphi_n(\bm{r}), 
	\label{eq:approx-wfc}
\end{equation}
%
where $\varphi_n$ are calculated through the equation
\begin{equation}
	\left[ -\frac{\nabla^2}{2} + v^{\rm n}_0[n, \chi, \Gamma](\bm{r}) - \mu \right]
	\varphi_n(\bm{r}) = \epsilon_n\varphi_n(\bm{r}).
	\label{eq:KS-eq}
\end{equation}
%
Then the eigenenergies in (\ref{eq:KS-BdG-par}) (\ref{eq:KS-BdG-hole}) is calculated as
%
\begin{equation}
	\widetilde{E}_n = {\rm sgn}(\xi_n)\sqrt{\xi^2_n + |\Delta_n|^2}
	                = {\rm sgn}(\xi_n) E_n
			\label{eq:KS-energy}
\end{equation}
%
where $\xi_n = \epsilon_n - \mu$, and the matrix elements $\Delta_n$ are defined as
%
\begin{equation}
	\Delta_n = \int d^3r\int d^3r' \varphi^{\ast}_n(\bm{r})\Delta_0(\bm{r}, \bm{r'})\varphi_n(\bm{r}).
	\label{eq:Deltan}
\end{equation}
%
In the decoupling approximation, the electronic densities and the anomalous densities 
can be obtained easily as follows
%
\begin{equation}
	n(\bm{r}) = \sum_{n} \left[1-\frac{\xi_n}{E_n}\tanh \left(\frac{\beta}{2}E_n \right) \right]
	                     |\varphi_n(\bm{r})|^2,
	\label{eq:el-density}
\end{equation}
%
\begin{equation}
	\chi(\bm{r}, \bm{r'}) = \sum_{n}\frac{\Delta_n}{2E_n}\tanh \left(\frac{\beta}{2}E_n \right)
	\varphi_n(\bm{r})\varphi^{\ast}_n(\bm{r'}).
	\label{eq:anom-density}
\end{equation}
%

Next, we consider the nucear equation. Now we are interested in superconductors at relatively low tempereutre, 
so it is reasonable to introduce the harmonic approximation. Then the equation (\ref{eq:BO-approx}) reads
%
\begin{equation}
	\hat{H}^{\rm ph}_{\rm 0} = \sum_{\lambda, \bm{q}}\Omega_{\lambda, \bm{q}}
	\left[\hat{b}^{\dag}_{\lambda, \bm{q}}\hat{b}_{\lambda, \bm{q}} + \frac{1}{2} \right],
	\label{eq:harm}
\end{equation}
%
where $\Omega_{\lambda, \bm{q}}$ represents the phonon eigenfrequencies and 
$\hat{b}^{\dag}_{\lambda, \bm{q}}$ and $\hat{b}_{\lambda, \bm{q}}$ are the creation and annihilation
operator of the phonon from the branch $\lambda$ and wavevector $\bm{q}$.
Then the nuclear density matrix is as follows
%
\begin{equation}
	\Gamma(\underline{\bm{R}}) = \sum_{\lambda, \bm{q}}n_\beta(\Omega_{\lambda, \bm{q}})
	|h_{\lambda, \bm{q}}(\bm{Q})|^2,
\end{equation}
%
where $n_\beta(\Omega)$ means the Bose occupation numbers and $h_{\lambda, \bm{q}}(\bm{Q})$ are
harmonic oscillator wavefunctions with respect to the collective coordinates $\bm{Q}$.

%Now we describe how to proceed the Kohn-Sham self-consistent calculation within the present approximations.
%At first, we approximate the Kohn-Sham potentials in order to start the self-consistent loop:
%(i) For $v^{\rm e}_0[n, \chi, \Gamma]$, we use the Kohn-Sham potential which comes from the 
%standard DFT caluclation for the nonsuperconducting ground state, i.e., $v^{\rm GS}_{\rm KS}[n]$.
%This approximation is reasonable because $v^{\rm e}_0[n, \chi, \Gamma]$ depends on $\chi$ and $\Gamma$ very weakly
%in the superconductors at low temperatures.
%(ii) For pair potential $\Delta_0[n, \chi, \Gamma]$, we start from a square well potential 
%centered at the Fermi energy which width is in the order of the Debye frequency and height is
%
Now we describe how to treat the density dependence of potentials in order to preceed calculations more simply.
(i) For $v^{\rm e}_0[n, \chi, \Gamma]$, we neglect the dependense on $\chi$ and $\Gamma$ because 
the typical electronic energies are three orders of magnitudes bigger than superconducting gap and phonons
and consequently they do not modify electronic structures so much.
(ii) For $v^{\rm n}_0[n, \chi, \Gamma]$, we neglect the dependence on $n$ and $\chi$ because
we use the Born-Oppenheimer approximation. This approximation is reasonable because
it is known that the calculations executed within the Born-Oppenheimer approximation well reproduce
the experimental phonon dispersions\cite{Baroni2001}.

\section{Gap equation}
%
Now we derive the gap equation for the potential $\Delta_n$. By inserting (\ref{eq:el-density}) 
and (\ref{eq:anom-density}) in (\ref{eq:Delta0}) and insert (\ref{eq:Delta0}) into the 
right-hand side of (\ref{eq:Deltan}), we get the gap equation
%
\begin{equation}
	\Delta_n = \Delta_{{\rm Hxc}, n}[n, \chi, \Gamma],
	\label{eq:Delta_gap}
\end{equation}
%
where $\Delta_{{\rm Hxc},n}$ means the sum of the Hartree and excanhge-correlation terms.

Around the transition temperature, the anomalous density $\chi$ becomes vanishingly small 
and the gap equation (\ref{eq:Delta_gap}) can be linearized as below
%
\begin{equation}
	\Delta_i = -\frac{1}{2}\sum_{j} {\mathcal F}_{{\rm Hxc}, i,j}[n, \chi, \Gamma]
	\frac{\tanh[(\beta/2)\xi_j]}{\xi_j}\Delta_j,
	\label{eq:line_gap}
\end{equation}
%
where ${\mathcal F}_{{\rm Hxc}, i,j}$ are the Hartree exchange-correlation energy kernels which defined as
%
\begin{equation}
	{\mathcal F}_{{\rm Hxc},i,j} = \left. -\frac{\delta \Delta_{{\rm Hxc}, i}}{\delta \chi_j} 
	                               \right|_{\chi = 0}
				       = \left. \frac{\delta^2(E^{\rm ee}_{\rm H}+F_{\rm xc})}
				       {\delta \chi^{\ast}_i \delta \chi_j} \right|_{\chi = 0},
	\label{eq:def-fxc}
\end{equation}
%
where we defined the matrix element of anomalous density $\chi_i$ as
%
\begin{equation}
	\chi_i = \int d^3r\int d^3r' \varphi^{\ast}_i(\bm{r})\chi(\bm{r}, \bm{r'})\varphi_i(\bm{r'}).
	\label{eq:chi_i_def}
\end{equation}
%
In practice, we solve the linearized gap equation (\ref{eq:line_gap}) with changing the temperature. 
When we get the vanishingly-small $\Delta_i$ solution at some temperature, we regard that temperature
as the superconducting transition temperature $T_{\rm c}$.
%

\section{Kernels of Gap Equation from functional derivatives}

Through the previous sections, we derived the gap equation (\ref{eq:line_gap}) from a density functional
theory for superconductors. In principle, it is able to calculate the $T_{\rm c}$ by solving 
the gap equation for any superconductors. However, in order to calculate the kernels 
${\mathcal F}_{{\rm Hxc},ij}$, 
we have to make approximations for $\Delta_{\rm xc}$ in (\ref{eq:Delta0}) which is defined in
(\ref{eq:Deltaxc}). In the following, we briefly review the Kohn-Sham perturbation theory,
as described by G\"{o}rling and Levy\cite{Levy1994}, 
and how to deribe the concrete expressions for ${\mathcal F}_{{\rm Hxc},ij}$.

We consider the electron-nuclear system which Hamiltonian is defined as (\ref{eq:Hamil}).
In order to apply the perturbation theory, we split the Hamiltonian into the unperturbed
Hamiltonian $\hat{H}_0$ and the reminder which is treated as perturbation.
In the unperturbed Hamiltonian, it is appropriate to consider that nuclei are fixed at their
equiliblium position $\underline{{\bm R}}_0$, which are defined by nuclear 
Kohn-Sham Hamiltonian (\ref{eq:BO-approx}). When applied the harmonic approximation,
it can be rewritten as the phonon Hamiltonian (\ref{eq:harm}).
%
Then we construct the Kohn-Sham Hamiltonian within the Born-Oppenheimer approximation as follows
%
\begin{equation}
	\hat{H}^{\rm e}_{\rm BO} = \hat{T}^{\rm e} + \hat{V}^{\rm e}_{{\rm latt},\underline{{\bm R}}_0}
	+ \hat{V}^{\rm e}_{\rm Hxc} + \hat{\Delta}_{\rm Hxc},
	\label{eq:BO-KS}
\end{equation}
%
where $\hat{V}^{\rm e}_{{\rm latt},\underline{\bm R}_0}$ is the potential from the nuclei fixed at their
equilibrium position $\underline{\bm R}_0$ and 
%
\begin{equation}
	\hat{V}^{\rm e}_{\rm Hxc} = \sum_{\sigma}\int d^3r\hat{\Psi}^{\dag}_{\sigma}({\bm r})
	\hat{\Psi}_{\sigma}({\bm r}) 
	\left[
		\int d^3r' \frac{n({\bm r'})}{|{\bm r}-{\bm r'}|} + v^{\rm e}_{\rm xc}(\bm r)
	\right]
\end{equation}
%
\begin{equation}
\begin{split}
	\hat{\Delta}_{\rm Hxc} = -\int d^3r \int d^3r'
	\left\{
		\hat{\Psi}_\uparrow({\bm r})\hat{\Psi}_\downarrow({\bm r'})
		\left[
			\frac{\chi^\ast({\bm r}, {\bm r'})}{|{\bm r}-{\bm r'}|} 
			+ \Delta^\ast_{\rm xc}({\bm r}, {\bm r'})
		\right]
		+ {\rm H.c.}
	\right\}
	\label{eq:DeltaHxc}
\end{split}
\end{equation}
%
means the normal and anomalous Hartree term and exchange-correlation term.

When we define the unperturbed Hamiltonian as $\hat{H}_0 = \hat{H}^{\rm ph}_0 + \hat{H}^{\rm e}_{\rm BO}$,
the interaction Hamiltonian becomes
%
\begin{equation}
	\hat{H}_1 = \hat{U}^{\rm ee} + \hat{U}^{\rm el-ph}_{\rm BO} - \hat{V}^{\rm n}_{\rm Hxc}
	- \hat{V}^{\rm e}_{\rm Hxc} - \hat{\Delta}_{\rm Hxc}.
	\label{eq:int_Hamil}
\end{equation}
%
The electron-phonon coupling operator within the Born-Oppenheimer approximation
$\hat{U}^{\rm el-ph}_{\rm BO}$ is 
%
\begin{equation}
	\hat{U}^{\rm el-ph}_{\rm BO} = \sum_{\sigma} \sum_{\lambda,{\bm q}}
	\int d^3r V^{\rm BO}_{\lambda, {\bm q}}({\bm r})
	\hat{\Psi}^\dag_\sigma({\bm r}) \hat{\Psi}_\sigma({\bm r})
	\hat{\Phi}_{\lambda, {\bm q}},
	\label{eq:el-ph-coup-ope}
\end{equation}
%
where $V^{\rm BO}_{\lambda, {\bm q}}({\bm r})$ is the gradient of the electronic Kohn-Sham potential
with respect to the nuclear collective coordinates $\bm Q$ and 
$\hat{\Phi}_{\lambda, {\bm q}} = \hat{b}^\dag_{\lambda,-{\bm q}} + \hat{b}_{\lambda, {\bm q}}$ is the
phononic field operator.
Using $V^{\rm BO}_{\lambda, {\bm q}}({\bm r})$, the electron-phonon coupling constant is deined as 
%
\begin{equation}
	g^{n{\bm k},n'{\bm k}+{\bm q}}_{\lambda {\bm q}} = \int d^3r \varphi^\ast_{n{\bm k}}({\bm r})
	V^{\rm BO}_{\lambda, {\bm q}}({\bm r})\varphi_{n'{\bm k}+{\bm q}}({\bm r}).
	\label{eq:el-ph-coup-g}
\end{equation}
%

We defined the Hamiltonian $\hat{H}_0$ and $\hat{H}_1$ above and now we can apply the perturbation
approach in order to obtain the explicit expression for kernels in gap equation defined as
(\ref{eq:def-fxc}).
Considering the definition of $F_{\rm xc}$ in (\ref{eq:Fxc-def}),
$F_{\rm xc}$ can be obtained by applying the perturbative approach to the difference of 
thermodynamic potentials $\Delta\Omega = \Omega - \Omega_0$ 
(see (\ref{eq:grand_pot}) and (\ref{eq:grand_pot_KS}))
and its functional derivatives with respect to the anomalous density become the kernels of the 
gap equation.

In the following, we introduce the explicit expressions for $F_{\rm xc}$ derived by L\"{u}ders {\it et al.}.
They expanded $\Delta\Omega$ in the series of topologically distinct connected diagrams 
and brought the lowest-order diagrams to derive $F_{\rm xc}$.

At first, we define and calculate the Kohn-Sham propagators which appear in considering diagrams.
The usual Green's function is defined as
%
\begin{equation}
	G^{\rm s}_{\sigma\sigma'}({\bm r}\tau,{\bm r'}\tau') = -
	\langle \hat{\mathcal T} \hat{\psi}_\sigma({\bm r}\tau)\hat{\psi}^\dag_{\sigma'}
	\left({\bm r'}\tau'\right)
	\rangle_{\rm s},
	\label{eq:Gfuncdef}
\end{equation}
%
where $\hat{\mathcal T}$ is the time-ordering operator and $\langle \cdots \rangle_{\rm s}$ 
means the average with respect to the Kohn-Sham density operator $\hat{\rho}_{\rm s}$.
The representation of this Green's function is Fig.\ref{fig:Garrow}.
%
In addition to the usual Green's function, following average which is nonvanishing
in superconductors should be considered:
%
\begin{equation}
	F^{\rm s}_{\sigma\sigma'}({\bm r}\tau,{\bm r'}\tau') = -
	\langle \hat{\mathcal T} \hat{\psi}_\sigma({\bm r}\tau)\hat{\psi}_{\sigma'}
	\left({\bm r'}\tau'\right)
	\rangle_{\rm s},
	\label{eq:Ffuncdef}
\end{equation}
%
\begin{equation}
	F^{{\rm s}\dag}_{\sigma\sigma'}({\bm r}\tau,{\bm r'}\tau') = -
	\langle \hat{\mathcal T} \hat{\psi}^\dag_\sigma({\bm r}\tau)\hat{\psi}^\dag_{\sigma'}
	\left({\bm r'}\tau'\right)
	\rangle_{\rm s}.
	\label{eq:Fdagfuncdef}
\end{equation}
%
These functions are represented in the Feynman diagrams as Fig.\ref{fig:Farrow} (for $F^{\rm s}$)
and Fig.\ref{fig:Fdagarrow} (for $F^{\rm s\dag}$).
%
\begin{figure}[h]
\begin{minipage}[b]{0.3\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.5]
	{../figure/method/Greenfuncarrow.eps}
	\label{fig:Garrow}
\end{minipage}
\begin{minipage}[b]{0.3\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.5]
	{../figure/method/Farrow.eps}
	\label{fig:Farrow}
\end{minipage}
\begin{minipage}[b]{0.3\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.5]
	{../figure/method/Fdagarrow.eps}
	\label{fig:Fdagarrow}
\end{minipage}
\caption{Diagram corresponding to (a) $G^{\rm s}$, (b) $F^{\rm s}$ and (c) $F^{\rm s\dag}$}
\label{fig:arrows}
\end{figure}
%
Finally, the phonon propagator represented as a wavy line is defined as 
%
\begin{equation}
	D^{\rm s}_{\lambda,{\bm q}}(\tau,\tau') = \langle \hat{\mathcal T}
	\hat{\Phi}_{\lambda, {\bm q}}(\tau)\hat{\Phi}^\dag_{\lambda, {\bm q}}(\tau')
	\rangle_{\rm s}.
	\label{eq:ph-prop}
\end{equation}
%
In practice, it is convenient to consider in the imaginary frequency space instead of the imaginary time space.
The Fourier transform from the imaginary time space to the imaginary frequency space 
of the normal Green's function (\ref{eq:Gfuncdef}) is defined as
%
\begin{equation}
	G^{\rm s}_{\sigma\sigma'}({\bm r}\tau,{\bm r'}\tau') = \frac{1}{\beta}
	\sum_{\omega_n}e^{-i\omega_n(\tau-\tau')}G^{\rm s}_{\sigma\sigma'}({\bm r},{\bm r'},\omega_n)
	,
	\label{eq:Fouriertrans}
\end{equation}
%
where $\omega_n=(2n+1)/\beta$ are the odd Matsubara frequencies. 
The transform for the anomalous propagators are defined similarly. 
With these definitions and after some calculations, the frequency-dependent propagators read
%
\begin{equation}
	G^{\rm s}_{\sigma\sigma'}({\bm r},{\bm r'},\omega_n) = \delta_{\sigma\sigma'}
	\sum_{i}
	\left[
		\frac{u_i(\bm r)u^\ast_i(\bm r')}{i\omega_n-E_i} - 
		\frac{v_i(\bm r)v^\ast_i(\bm r')}{i\omega_n+E_i}
	\right],
	\label{eq:Gfreq}
\end{equation}
%
\begin{equation}
	F^{\rm s}_{\sigma\sigma'}({\bm r},{\bm r'},\omega_n) = \delta_{\sigma,-\sigma'}{\rm sgn}(\sigma')
	\sum_{i}
	\left[
		\frac{v^\ast_i(\bm r)u_i(\bm r')}{i\omega_n+E_i} - 
		\frac{u_i(\bm r)v^\ast_i(\bm r')}{i\omega_n-E_i}
	\right],
	\label{eq:Ffreq}
\end{equation}
%
\begin{equation}
	F^{\rm s\ast}_{\sigma\sigma'}({\bm r},{\bm r'},\omega_n) = \delta_{\sigma,-\sigma'}{\rm sgn}(\sigma)
	\sum_{i}
	\left[
		\frac{u^\ast_i(\bm r)v_i(\bm r')}{i\omega_n+E_i} - 
		\frac{v_i(\bm r)u^\ast_i(\bm r')}{i\omega_n-E_i}
	\right],
	\label{eq:Fdagfreq}
\end{equation}
%
in terms of the Kohn-Sham eigenfunctions and the Kohn-Sham eigenenergies 
(see from (\ref{eq:approx-wfc}) to (\ref{eq:KS-energy})).
On the other hand, the Fourier transform of phonon propagator is defined as
%
\begin{equation}
	D^{\rm s}_{\lambda, \bm q}(\nu_n) = - \frac{2\Omega_{\lambda, \bm q}}
	{\nu^2_n + \Omega^2_{\lambda, \bm q}},
	\label{eq:phtrans}
\end{equation}
%
where $\nu_n = 2n\pi/\beta$ are the even Matsubara frequencies.
Now we are ready to derive the explicit expressions for lowest-order contributions to $F_{\rm xc}$.
As mentioned before, now we consider the contributions from the Coulomb interaction and the electron-phonon interaction
but do not consider the effect of spin fluctuations.

%
\begin{figure}[h]
\begin{minipage}[b]{0.5\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.7]
	{../figure/method/Fbxc.eps}
	\label{fig:Fbxc}
\end{minipage}
\begin{minipage}[b]{0.5\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.7]
	{../figure/method/Fcxc.eps}
	\label{fig:Fcxc}
\end{minipage}
\caption{Lowest-order phononic contributions to $F_{\rm xc}$.}
\end{figure}
%
\clearpage
%
\subsection*{Phononic kernels}
Lowest-order contributions from electron-phonon interaction can be written as
%
\begin{equation}
	F^{(1)}_{\rm xc} = \frac{1}{2}
	\sum_{\lambda, {\bm q}}\sum_{ij} |g^{ij}_{\lambda,{\bm q}}|^2
	\frac{\Delta_i\Delta^\ast_j}{E_iE_j}
	\left[
		I(E_i,E_j,\Omega_{\lambda,{\bm q}}) - I(E_i,-E_j,\Omega_{\lambda,{\bm q}})
	\right],
	\label{eq:Fbxc}
\end{equation}
%
\begin{equation}
	F^{(2)}_{\rm xc} = - \frac{1}{2} 
	\sum_{\lambda, {\bm q}}\sum_{ij} |g^{ij}_{\lambda,{\bm q}}|^2
	\left[
		\left( 1 + \frac{\xi_i}{E_i}\frac{\xi_j}{E_j} \right) I(E_i, E_j, \Omega_{\lambda, {\bm q}})
		+ \left( 1 - \frac{\xi_i}{E_i}\frac{\xi_j}{E_j} \right) I(E_i, -E_j, \Omega_{\lambda, {\bm q}})
	\right],
	\label{eq:Fcxc}
\end{equation}
%
where the explicit form of function $I$ is 
%
\begin{equation}
	I(E_i, E_j, \Omega) = f_\beta(E_i)f_\beta(E_j)n_\beta(\Omega)
	\left[
		\frac{e^{\beta E_i}-e^{\beta(E_j+\Omega)}}{E_i-E_j-\Omega} -
		\frac{e^{\beta E_j}-e^{\beta(E_i+\Omega)}}{E_i-E_j+\Omega}
	\right].
	\label{eq:Ifunc}
\end{equation}
%
The diagrammatic expression for $F^{(1)}_{\rm xc}$ and $F^{(2)}_{\rm xc}$ is depicted in 
Figs.\ref{fig:Fbxc} and \ref{fig:Fcxc}, respectively.

Now we can compute the phononic contributions to the exchange-correlation kernels ${\mathcal F}_{{\rm Hxc},ij}$
(see (\ref{eq:def-fxc})).
The exchange-correlation kernel arising from $F^{(1)}_{\rm xc}$ is nondiagonal and its form is
%
\begin{equation}
	{\mathcal F}^{(1)}_{{\rm Hxc},ij}
	\equiv{\mathcal K}^{\rm ph}_{ij} = \frac{2}{\tanh[(\beta/2)\xi_i]\tanh[(\beta/2)\xi_j]}
	\sum_{\lambda, \bm q} |g^{ij}_{\lambda, \bm q}|^2
	\left[
		I(\xi_i, \xi_j, \Omega_{\lambda, \bm q}) - I(\xi_i, -\xi_j, \Omega_{\lambda, \bm q})
	\right].
	\label{eq:Kph}
\end{equation}
%
On the other hand, the exchange-correlation kernel arising from $F^{(2)}_{\rm xc}$ is diagonal.
Now we define the diagonal part of exchange-correlation kernel ${\mathcal Z}^{\rm ph, full}_i$ as
%
\begin{equation}
	{\mathcal F}^{(2)}_{{\rm Hxc},ij} = \delta_{ij}
	\frac{E_i}{\tanh[(\beta/2)\xi_i]}{\mathcal Z}^{\rm ph,PT}_i,
	\label{eq:FxcZphPT}
\end{equation}
and its explicit form derived by perturbation theory (PT) directly reads
%
\begin{equation}
\begin{split}
	\label{eq:ZphPT}
	{\mathcal Z}^{\rm ph, PT}_i &= - \frac{2}{\sum_{j} \frac{\beta/2}{\cosh^2[(\beta/2)\xi_j]}}
	\left[
		\frac{1}{\xi_i} - \frac{\beta/2}{\sinh[(\beta/2)\xi_i]\cosh[(\beta/2)\xi_i]}
	\right]
	\sum_{jl}\sum_{\lambda, \bm q} |g^{jl}_{\lambda, \bm q}|^2 I'(\xi_i, \xi_j, \Omega_{\lambda, \bm q}) \\
	&\quad + \frac{1}{\tanh[(\beta/2)\xi_i]}
	\sum_{j}\sum_{\lambda, \bm q} |g^{ij}_{\lambda, \bm q}|^2
	\left\{
		\frac{1}{\xi_j} [I(\xi_i, \xi_j, \Omega_{\lambda, \bm q}) - I(\xi_i, -\xi_j, \Omega_{\lambda, \bm q})]
		- 2I'(\xi_i, \xi_j, \Omega_{\lambda, \bm q})
	\right\},
\end{split}
\end{equation}
%
where the function $I'$ is defined as
%
\begin{equation}
	I'(\xi_i, \xi_j, \Omega_{\lambda, \bm q}) = 
	\frac{\partial}{\partial \xi_i} I(\xi_i, \xi_j, \Omega_{\lambda, \bm q}).
	\label{eq:Iprime}
\end{equation}
%
However, it is found that the direct use of ${\mathcal Z}^{\rm ph, PT}_i$ leads numerical instabilities\cite{Luders2005_1},
then an alternative expression is developed. The numerically-stable expression for diagonal kernel is 
%
\begin{equation}
	{\mathcal Z}^{\rm ph}_i = \frac{1}{\tanh[(\beta/2)\xi_i]}
	\sum_{j}\sum_{\lambda, \bm q} |g^{ij}_{\lambda, \bm q}|^2
	\left[
		J(\xi_i, \xi_j, \Omega_{\lambda, \bm q}) +
		J(\xi_i, -\xi_j, \Omega_{\lambda, \bm q})
	\right],
	\label{eq:Zphprac}
\end{equation}
%
where the function $J$ is defined as
%
\begin{equation}
	J(\xi, \xi, \Omega) = \tilde{J}(\xi, \xi, \Omega) + \tilde{J}(\xi, \xi, -\Omega), 
	\label{eq:Jfunc}
\end{equation}
%
\begin{equation}
	\tilde{J}(\xi, \xi', \Omega) = 
	- \frac{f_\beta(\xi) + n_\beta(\Omega)}{\xi-\xi'-\Omega}
	\left[
		\frac{f_\beta(\xi') + f_\beta(\xi-\Omega)}{\xi-\xi'-\Omega} -
		\beta f_\beta(\xi-\Omega) f_\beta(-\xi'+\Omega)
	\right].
	\label{eq:Jtildefunc}
\end{equation}
%
%
\subsection*{Electron-electron kernels}
%
We now develop the exchange-correlation kernels arising from the Coulomb interaction.
From the definition of ${\mathcal F}_{{\rm Hxc},ij}$ (\ref{eq:def-fxc}), it can be seen that
there are two terms that contribute to the kernels. The first is the anomalous Hartree energy (\ref{eq:anomHartree}), 
and the second is the exchange-correlation free energy $F^{(3)}_{\rm xc}$ (Fig.\ref{fig:Fcoulxc}).
%
\begin{figure} %%%%%%% FIGURE Coulombic free energy
	\centering
	\includegraphics[width=5truecm,clip]{../figure/method/Fcoulxc.eps}
	\caption{Lowest-order electronic contributions to the $F_{\rm xc}$. A dashed line means the screened Coulomb interaction.}
	\label{fig:Fcoulxc}
\end{figure}
%
For convenience, an approximation is applied to {\it both} of the anomalous Hartree energy and $F_{\rm xc}$ 
as follows\cite{Luders2005_1}:
%
\begin{equation}
	F^{(3)}_{\rm xc} + E^{{\rm ee}, \chi}_{\rm H} = \int d^3r \int d^3r'
	\Big| \chi(\bm r - \bm r') \Big|^2 v^{\rm screen}(\bm r - \bm r'),
	\label{Fcoulxcapprox}
\end{equation}
%
where $v^{\rm screen}(\bm r - \bm r')$ means a static screened Coulomb interaction.
Within this approximation, the exchange-correlation kernel from electron-electron interaction
can be written as
%
\begin{equation}
	\label{eq:Kel}
\begin{split}
	{\mathcal K}^{\rm el}_{ij} &\equiv \frac{\delta^2 \left( F^{(3)}_{\rm xc} + E^{{\rm ee},\chi}_{\rm H} \right)}
	{\delta \chi^\ast_i \delta\chi_j} \\
	& = v^{\rm scr}_{ij},
\end{split}
\end{equation}
%
where
%
\begin{equation}
	v^{\rm scr}_{ij} = \int d^3r \int d^3r' \varphi^\ast_i(\bm r)\varphi_i({\bm r'})
	v^{\rm scr}(\bm r, {\bm r'}) \varphi_j(\bm r) \varphi^\ast_j({\bm r'}).
	\label{eq:Keldef}
\end{equation}
%

There are some way how to approximate the screened Coulomb interaction $v^{\rm scr}(\bm r, \bm r')$. 
L\"{u}ders {\it et al.} applied the Thomas-Fermi interaction to the Coulomb interaction\cite{Luders2005_1}.
There are also some studies which applies the random phase approximation to $v^{\rm scr}$\cite{RA2012}.
In our calculation, we applied the adiabatic local density approximation(ALDA)\cite{Zangwill1980} and 
so we now summarize the expression for the screened Coulomb interaction in ALDA.
Furthermore, it should be taken account of the dynamical structure of the Coulomb interaction which is represented by
the frequency-dependent polarization function $\Pi$.
The polarization function $\Pi$ is obtained by the following equation
%
\begin{equation}
	\Pi(\bm r, \bm r', \omega) = \Pi_0(\bm r, \bm r', \omega) + 
	\iint d^3r_1d^3r_2\Pi_0(\bm r, \bm r_1, \omega) 
	\left(
	\frac{1}{|\bm r_1 - \bm r_2|} + \frac{\delta^2E_{\rm xc}}{\delta\rho(\bm r_1)\delta\rho(\bm r_2)}
	\right)
	\Pi(\bm r_2, \bm r', \omega), 
	\label{eq:Pieq}
\end{equation}
%
where $\Pi_0$ indicates the independent-particle polarization function
%
\begin{equation}
	\Pi_0(\bm r, \bm r', \omega) = \sum_{ij}
	\frac{\theta(-\xi_i)-\theta(\xi_j)}{\xi_j-\xi_i+i\omega}
	\varphi^\ast_i(\bm r)\varphi^\ast_j(\bm r')\varphi_i(\bm r')\varphi_j(\bm r),
	\label{eq:chi0}
\end{equation}
%
where $\theta(\xi)$ is the step function. We used adiabatic local density apploximation(ALDA)\cite{TDDFT} to calculate
the polarization function $\Pi$. Now the screened Coulomb interaction within the ALDA is written as
%
\begin{equation}
	v^{\rm scr}(\bm r, \bm r', \omega) = \frac{1}{|\bm r - \bm r'|} + 
	\iint d^3r_1 d^3r_2 
	\left(
	\frac{1}{|\bm r - \bm r_1|} + \frac{\delta^2E_{\rm xc}}{\delta\rho(\bm r)\delta\rho(\bm r_1)}
	\right)
	\Pi(\bm r_1, \bm r_2, \omega) \frac{1}{|\bm r_2 - \bm r'|}
	\label{eq:vscr}
\end{equation}
%
If we take into account of the frequency-dependent screened Coulomb interaction,
the formulation for ${\mathcal K}^{\rm el}_{ij}$ should be modified as follows\cite{ra2013}:
%
\begin{equation}
	{\mathcal K}^{\rm el, dyn}_{n\bm k,n'\bm k'} = 
	\lim_{\{\Delta_{n\bm k}\} \to 0}
	\frac{1}{\tanh[(\beta/2)E_{n\bm k}]}\frac{1}{\tanh[(\beta/2)E_{n'\bm k'}]}
	\frac{1}{\beta^2}
	\sum_{\tilde{\omega}_1\tilde{\omega}_2}
	F_{n\bm k}({\rm i}\tilde\omega_1)F_{n'\bm k'}({\rm i}\tilde\omega_2)
	W_{n\bm kn'\bm k'}[{\rm i}(\tilde\omega_1 - \tilde\omega_2)],
	\label{eq:Keldyn}
\end{equation}
%
where $F_{n\bm k}({\rm i}\tilde\omega) = 
\frac{1}{\rm i \tilde\omega + E_{n\bm k}}-\frac{1}{\rm i \tilde\omega - E_{n\bm k}}$
and $\tilde\omega$ means the bosonic Matsubara frequency and we defined 
$W_{n\bm kn'\bm k'}({\rm i}\omega)$ as below
%
\begin{equation}
	W_{n\bm kn'\bm k'}({\rm i}\omega) = 
	\int d^3r \int d^3r' \varphi_{n\bm k}(\bm r)\varphi_{n-\bm k}({\bm r'})
	v^{\rm scr}(\bm r, {\bm r'}, \omega) \varphi_{n'\bm k'}(\bm r) \varphi_{n'-\bm k'}({\bm r'}).
	\label{eq:dynWnknk}
\end{equation}
%
We describe how to calcurate the summation with respect to the even Matsubara frequency in (\ref{eq:Keldyn})
in Appendix.
Using the kernels derived above, the resulting SCDFT gap equation is written as
%
\begin{equation}
	\Delta_{n\bm k} = -{\mathcal Z}_{n \bm k}\Delta_{n\bm k} - \frac{1}{2}
	\sum_{n'\bm k'}{\mathcal K}_{n\bm k n \bm k'}
	\frac{\tanh[(\beta/2)E_{n' \bm k'}]}{E_{n' \bm k'}}\Delta_{n' \bm k'},
	\label{eq:truegapeq}
\end{equation}
%
where $\mathcal Z$ contains the phonon contribution (\ref{eq:Zphprac}) and $\mathcal K$ contains 
the phonon term (\ref{eq:Kph}) and Coulombic term (\ref{eq:Keldyn}).
\section{Spin fluctuations kernel from Sham-Shl\"{u}ter connection}
In the previous section, we derived the phononic and 
electron-electron Coulomb kernel from functional derivatives.
Now we review the derivation of the expression for kernels arising 
from spin fluctuations by Essenberger and coworkers\cite{Essenberger2014}.
In the following, we will construct the SCDFT gap equation from the Sham-Shl\"{u}ter connection
including the effect of spin fluctuations and derive the expression for the kernel from the spin fluctuations.

\subsection{Spin fluctuations contribution to the self-energy}

\begin{figure} %%%%%%% FIGURE Coulombic free energy
	\centering
	\includegraphics[width=5truecm,clip]{../figure/method/self-energy.eps}
	\caption{Self-energy diagram of spin fluctuations described with particle-hole propagator $\Lambda$. A double-line indicates the full Green's function.}
	\label{fig:SF-self}
\end{figure}

In order to surpass the GW approximation, at first the $T$-matrix\cite{Gordon1961,Ersoy2010} is considered.
The $T$-matrix is defined through the Bethe-Salpeter equation\cite{BSE1951} as
%
\begin{equation}
	T(1,2,3,4) = w(1,3)\delta_{13}\delta_{24} + 
	w(1,2)G(1,5)G(2,6)T(5,6,3,4),
	\label{eq:T-BSE}
\end{equation}
%
where $w$ indicates the screened Coulomb interaction.
The coordinate 1 indicates that $1=\{\bm r_1, \tau_1, \sigma_1\}$, 
where $\bm r_1$, $\tau_1$, $\sigma_1$ is the real space coordinate,
the Matsubara imaginary time and the spin index, respectively.
Using this $T$-matrix, the contribution of spin fluctuations to the self-energy can be written as $\bar{\Sigma}^{T}=\bar{G}T$.
Is is known that the response function within the $T$-matrix approximation reasonably describes the magnetic response function\cite{Ersoy2010,Onida2002}.
However, due to the reason we discuss later, we do not directly use this $T$-matrix.

Alternatively, we start from particle-hole propagator $\Lambda$ in order to 
take account of spin fluctuations in self-energy (Fig. \ref{fig:SF-self}).
Particle-hole propagator $\Lambda$ contains all irreducible 
diagrams with respect to Coulomb interaction and has two 
incoming and outgoing points. The $T$-matrix is fully contained in the$\Lambda$.
In the following, we assume that we consider about the case of collinear magnetic systems and 
then the Green's function becomes diagonal with respect to spin indices.
We consider one of the Hedin's equation\cite{Sole1994} which is depicted
in Fig.\ref{fig:Hedineq}
%
\begin{equation}
	\Gamma(1,2,3) = \delta(1,2)\delta(1,3) + 
	\int d(4,5,6,7)\Lambda_0(1,2,4,5)
	G(4,6)G(7,5)\Gamma(6,7,3),
	\label{eq:Hedineq}
\end{equation}
%
where 
%
\begin{equation}
	\Lambda_0(1,2,3,4) = \frac{\delta\Sigma^{\rm V}(1,2)}{\delta G(3,4)}.
	\label{eq:lambda0}
\end{equation}
%
\begin{figure} %%%%%%% FIGURE Hedin's eq.
	\centering
	\includegraphics[width=8truecm,clip]{../figure/method/Hedineq.eps}
	\caption{Diagrammatic representation of one of the Hedin's equations.}
	\label{fig:Hedineq}
\end{figure}
The coordinates 1 and 4 are connected to the lines which go outside,
and the coordinates 2 and 3 are connected to the lines which come inside.
$\Lambda_0$ is called an irreducible particle-hole propagator\cite{Arya2008}.
The self-energy used to calculate $\Lambda_0$ is written as $\Sigma^{\rm V}$.
We will apply an approximation for $\Sigma^{\rm V}$ later.
The $\Lambda_0$ contains all connected and irreducible diagrams with
respect to the Coulomb interaction and the particle-hole propagator.
If we obtain the $\Lambda_0$, we can get the $\Lambda$ by using the
Bethe-Salpeter equation(BSE)\cite{BSE1951} for $\Lambda$.
However, before considering the BSE for $\Lambda$, we have to note that
there can be two possible contributions to $\Lambda_0$.

The functional derivative of the self-energy with respect to $G$ 
correspond to the removal of one Green's function in self-energy. 
Hence, the two possible contributions to $\Lambda_0$ come from
the type of the Green's function which is removed.
If the removed Green's function was a factor of a loop, we call
the resulting contribution to $\Lambda_0$ as direct contribution $\Lambda^{\rm d}$.
Otherwise, we call these contributions as crossed ones and define as $\Lambda^{\rm c}$.
Then we can write these contributions as follows:
%
\begin{equation}
	\Lambda^{\rm c}_0(1,2,3,4) \equiv \delta_{\sigma_1\sigma_3}
	\delta_{\sigma_2\sigma_4}\Lambda^{\rm c}_0(1,2,3,4),
	\label{eq:defcross}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm d}_0(1,2,3,4) \equiv \delta_{\sigma_1\sigma_2}
	\delta_{\sigma_3\sigma_4}\Lambda^{\rm d}_0(1,2,3,4).
	\label{eq:defdirect}
\end{equation}
%
It should be noted that crossed and direct contributions have different 
signs because one loop is removed in case of direct ones:
%
\begin{equation}
	\Lambda^{\rm c}_0(1,2,3,4) = \frac{\delta\Sigma^{\rm V}(1,2)}
	{\delta G(3,4)}, 
	\label{eq:cross}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm d}_0(1,2,3,4) = -\frac{\delta\Sigma^{\rm V}(1,2)}
	{\delta G(3,4)}.
	\label{eq:direct}
\end{equation}
%
From Eqs. (\ref{eq:lambda0}), (\ref{eq:cross}) and (\ref{eq:direct}), 
the total irreducible particle-hole propagator can be written as follows:
%
\begin{equation}
	\Lambda_0(1,2,3,4) = \frac{\delta\Sigma^{\rm V}(1,2)}{\delta G(3,4)}
	= \Lambda^{\rm c}_0 - \Lambda^{\rm d}_0 \equiv \Lambda^{{\rm c} - {\rm d}}_0.
	\label{eq:lambdadiff}
\end{equation}
%
\begin{figure}[h]
\centering{
\begin{minipage}[b]{0.3\linewidth}
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.5]
	{../figure/method/crosscross.eps}
	\label{fig:crosscross}
\end{minipage}
\begin{minipage}[b]{0.3\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.5]
	{../figure/method/crossdirect.eps}
	\label{fig:crossdirect}
\end{minipage}
\begin{minipage}[b]{0.3\linewidth}
	\centering
	\subcaption{}
	\includegraphics[keepaspectratio, scale=0.5]
	{../figure/method/directdirect.eps}
	\label{fig:directdirect}
\end{minipage}
\caption{Diagrammatic representation how higher order propagator is constructed. Bold dashed lines indicate that connected two points have the same spins.}
}
\end{figure}
%
Furthermore, we have to consider how higher order irreducible particle-hole propagators are constructed.
There can be three patterns how crossed and direct contributions are linked:
(a) If two crossed contributions are connected, the resulting contribution is also crossed one(Fig.\ref{fig:crosscross}).
(b) If crossed and direct contributions are linked, the resulting contribution becomes direct one(Fig.\ref{fig:crossdirect}).
(c) If two direct contributions are linked, the resulting contribution is also direct one(Fig.\ref{fig:directdirect}). 
In this case, we have to pay attention to the sign of this contribution because one additional loop appears.

With these considerations, the BSE for $\Lambda$ becomes as follows:
%
\begin{equation}
	\Lambda = \sum_{n=0}^{\infty}\Lambda^{\rm c}_{(n)} + \sum_{n=0}^{\infty}\Lambda^{\rm d}_{(n)},
	\label{eq:BSE}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm c}_{(n+1)} = \Lambda^{\rm c}_0GG\Lambda^{\rm c}_{(n)},
	\label{eq:cnplus1}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm d}_{(n+1)} = \Lambda^{\rm d}_0GG\Lambda^{\rm c}_{(n)}
	+ \Lambda^{\rm c}_0GG\Lambda^{\rm d}_{(n)}
	- \Lambda^{\rm d}_0GG\Lambda^{\rm d}_{(n)},
	\label{eq:dnplus1}
\end{equation}
%
where $(n)$ means the order of the irreducible particle-hole propagator
and $\Lambda^{\rm c, \rm d}_{(0)}$ is equal to $\Lambda^{\rm c, \rm d}_0$ defined in Eqs.(\ref{eq:defcross}) and (\ref{eq:defdirect}).
From Eqs.(\ref{eq:cnplus1}) and (\ref{eq:dnplus1}), we obtain the BSE for $\Lambda^{\rm c - \rm d}$ as
%
\begin{equation}
	\Lambda^{\rm c - \rm d}= \Lambda_0 + 
	\Lambda_0GG\Lambda^{\rm c - \rm d},
	\label{eq:BSELambda}
\end{equation}
%
where $\Lambda_0$ is defined in Eq.(\ref{eq:lambdadiff}).

\begin{figure} %%%%%%% FIGURE F-self-energy
	\centering
	\includegraphics[width=5truecm,clip]{../figure/method/Fself.eps}
	\caption{Crossed and direct contribution to self-energy with anomalous Green's function $F$.}
	\label{fig:Fself}
\end{figure}
So far, we considered only the normal Green's function because
we neglected the effects of spin fluctuations on superconductors.
We are interested in the theory in superconductors, so we have to 
construct the self-energy comes from spin fluctuations(Fig.\ref{fig:SF-self})
with normal and anomalous Green's functions(Fig.\ref{fig:arrows}).
In anomalous terms in which $F$ and $F^\dag$ appear, no loop is created
when we construct the self-energy(Fig.\ref{fig:Fself}).
Therefore, crossed and direct contribution to the self-energy have the 
same sign and the resulting expression reads
%
\begin{equation}
	\bar{\Sigma}^{\rm SF}_F \equiv \iint d34 \tau^{\rm z}
	\begin{pmatrix}
		0 & F(3,4)\Lambda^{\rm c + \rm d}(1,3,4,2) \\
		F^\dag(3,4)\Lambda^{\rm c + \rm d}(3,1,2,4) &0
	\end{pmatrix}.
	\label{eq:Fself}
\end{equation}
%
In this expression, the order of coordinates in $\Lambda$ correspond to the definition of $\Lambda$ as stated before.
On the other hand, in normal contributions, the sign of crossed term and
direct one is different because one extra loop appears in the crossed term(Fig.\ref{fig:Gself}).
%
\begin{figure} %%%%%%% FIGURE G-self-energy
	\centering
	\includegraphics[width=5truecm,clip]{../figure/method/Gself.eps}
	\caption{Crossed and direct contribution to self-energy with normal Green's function $G$.}
	\label{fig:Gself}
\end{figure}
%
With this normal contributions, the equation of the self-energy from spin fluctuations can be written as follows:
%
\begin{equation}
	\bar{\Sigma}^{\rm SF} \equiv \iint d34 \tau^{\rm z}
	\begin{pmatrix}
		-G(3,4)\Lambda^{\rm c - \rm d}(1,3,2,4) & F(3,4)\Lambda^{\rm c + \rm d}(1,3,4,2) \\
		F^\dag(3,4)\Lambda^{\rm c + \rm d}(3,1,2,4) & -G^\dag(3,4)\Lambda^{\rm c - \rm d}(3,1,4,2)
	\end{pmatrix}.
	\label{eq:GFself}
\end{equation}
%

We obtained the equation for the self-energy from spin fluctuations with $\Lambda^{\rm c + \rm d}$ and $\Lambda^{\rm c - \rm d}$.
We can simplify the expression because it is already assumed that we are now interested in singlet cuperconductor and magnetic collinear system.
From this assumption, we already know that the normal Green's function 
conserves the spin while the anomalous one flips the spin(see from Eq.
(\ref{eq:Gfuncdef}) to Eq.(\ref{eq:Fdagfuncdef})).
According to these spin properties of Green's functions, it can be seen that
the 11 and 22 element of Eq.(\ref{eq:GFself}) depend only on $\Lambda^{\rm c - \rm d}_{\sigma_1\sigma\sigma_2\sigma}$ 
while the 12 and 21 element depend only on $\Lambda^{\rm c + \rm d}_{\sigma_1\sigma-\sigma\sigma_2}$.

Furthermore, considering the spin properties of $\Lambda^{\rm c}$ and 
$\Lambda^{\rm d}$ (see Eq.(\ref{eq:defcross}) and (\ref{eq:defdirect})),
following relations can be straightforwardly derived:
%
\begin{equation}
	\Lambda^{\rm c + \rm d}_{\sigma\sigma-\sigma-\sigma} =
	\Lambda^{\rm d}_{\sigma\sigma-\sigma-\sigma} =
	- \Lambda^{\rm c - \rm d}_{\sigma\sigma-\sigma-\sigma},
	\label{eq:lambdasimp1}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm c + \rm d}_{\sigma-\sigma\sigma-\sigma} =
	\Lambda^{\rm c}_{\sigma-\sigma\sigma-\sigma} =
	\Lambda^{\rm c - \rm d}_{\sigma-\sigma\sigma-\sigma}.
	\label{eq:lambdasimp2}
\end{equation}
%
By using these relations, we can rewrite the expression of the self-energy as follows:
%
\begin{equation}
	\bar{\Sigma}^{\rm{SF}}_{11} = -\delta_{\sigma_1\sigma_2}G_{\sigma_1}
	\sum_{\sigma}\Lambda^{\rm c - \rm d}_{\sigma_1\sigma\sigma_1\sigma},
	\label{eq:Sigma11}
\end{equation}
%
\begin{equation}
	\bar{\Sigma}^{\rm{SF}}_{22} = \delta_{\sigma_1\sigma_2}G^{\dag}_{\sigma_1}
	\sum_{\sigma}\Lambda^{\rm c - \rm d}_{\sigma\sigma_1\sigma\sigma_1},
	\label{eq:Sigma22}
\end{equation}
%
\begin{equation}
	\bar{\Sigma}^{\rm{SF}}_{12} = \delta_{\sigma_1-\sigma_2}F_{\sigma_1}
	\sum_{\sigma}(1-2\delta_{\sigma\sigma_1})\Lambda^{\rm c - \rm d}_{\sigma_1\sigma-\sigma-\sigma_1},
	\label{eq:Sigma12}
\end{equation}
%
\begin{equation}
	\bar{\Sigma}^{\rm{SF}}_{21} = -\delta_{\sigma_1-\sigma_2}F^{\dag}_{\sigma_1}
	\sum_{\sigma}(1-2\delta_{\sigma\sigma_1})\Lambda^{\rm c - \rm d}_{\sigma\sigma_1-\sigma_1-\sigma}.
	\label{eq:Sigma21}
\end{equation}
%
This is a more convenient result than Eq.({\ref{eq:GFself}}) because 
we have to solve the BSE for only $\Lambda^{\rm c - \rm d}$ and 
we do not have to compute both $\Lambda^{\rm c}$ and $\Lambda^{\rm d}$ separately.
In the above expression, we omitted the integral and we will use this 
notation below unless the expression leads any ambiguity. 

In the previous explanation, we derived the approximated expression of the self-energy from spin fluctuations.
However, there is one problem in the previous expression.
If we want to calculate the self-energy along with the expression from (\ref{eq:Sigma11}) to (\ref{eq:Sigma21}), 
we need to calculate the four-point function $\Lambda^{\rm c - \rm d}$ and the resulting integration omitted in the previous expressions becomes 
too complex to execute.
In order to avoid this difficulty, we apply a crude approximation to the
self-energy $\Sigma^{V}$ which is used to calculate $\Lambda_0$ (see Eq.(\ref{eq:lambda0})) and obtain the $\Lambda$ as a two-point function.
The approximation is that we use the Kohn-Sham potential as the $\Sigma^{V}$\cite{Sole1994}:
%
\begin{equation}
	\Sigma^{V}(1,2) \approx \delta_{\tau_1\tau_2}\delta_{\bm r_1\bm r_2}
	v^{\rm xc}_{\sigma_1\sigma_2}(\bm r_1 \tau_1),
	\label{eq:localapp}
\end{equation}
%
where $v^{\rm xc}$ means the Kohn-Sham potential.
Within this approximation, the functional derivative of $\Sigma^{V}$
can be calculated using the following result:
%
\begin{equation}
\begin{split}
	\frac{\delta v^{\rm xc}_{\sigma_1\sigma_2}(\bm x_1)}{\delta G(3,4)}
	&= \sum_{\sigma_5\sigma_6} \int d{\bm x}_5 
	\frac{\delta v^{\rm xc}_{\sigma_1\sigma_2}(\bm x_1)}{\delta\rho_{\sigma_5\sigma_6}(\bm x_5)}
	\frac{\delta\rho_{\sigma_5\sigma_6}(\bm x_5)}{\delta G(3,4)} \\
	&= \iint d5d6 f^{\rm xc}_{\sigma_1\sigma_2\sigma_5\sigma_6}(\bm x_1 \bm x_5)
	\frac{\delta G(5,6)}{\delta G(3,4)}\delta_{\bm x_5\bm x_6} \\
	&= f^{\rm xc}_{\sigma_1\sigma_2\sigma_5\sigma_6}(\bm x_1, \bm x_3)\delta_{\bm x_3 \bm x_4},
	\label{eq:dervxc}
\end{split}
\end{equation}
%
where $\bm x_1 = (\bm r_1 \tau_1)$ and $f^{\rm xc}$ is defined as
%
\begin{equation}
	f^{\rm xc}_{\sigma_1\sigma_2\sigma_5\sigma_6}(\bm x_1 \bm x_5)
	\equiv 
	\frac{\delta v^{\rm xc}_{\sigma_1\sigma_2}(\bm x_1)}{\delta\rho_{\sigma_5\sigma_6}(\bm x_5)}.
	\label{eq:deffxc}
\end{equation}
%

%If we approximate the full Green's function in (\ref{eq:BSELambda}) by the Kohn-Sham one, 
%the BSE for $\Lambda^{\rm c - \rm d}$ can be written formally as
%
%\begin{equation}
%	\begin{split}
%	\Lambda^{\rm c - \rm d} &= 4f^{\rm xc} + 16f^{\rm xc}G^{\rm KS}G^{\rm KS}f^{\rm xc}
%	+ 64f^{\rm xc}G^{\rm KS}G^{\rm KS}f^{\rm xc}G^{\rm KS}G^{\rm KS}f^{\rm xc} + \cdots \\
%	&= 4f^{\rm xc} + 16f^{\rm xc}\frac{\chi^{\rm KS}}{1-f^{\rm xc}\chi^{\rm KS}}f^{\rm xc}, 
%	\label{eq:Dysonlambda}
%\end{split}
%\end{equation}
%
%where $\chi^{\rm KS}$ is the Kohn-Sham susceptibility. If we write the spin indices explicitly,
%the above expression can be written as follows:
%
If we approximate the full Green's function in (\ref{eq:BSELambda}) by the Kohn-Sham one, 
the BSE for $\Lambda^{\rm c - \rm d}$ can be written as
\begin{equation}
	\Lambda^{\rm c - \rm d}_{\sigma_1\sigma_1\sigma_2\sigma_2} = 4f^{\rm xc}_{\sigma_1\sigma_1\sigma_2\sigma_2} 
	+ 16 \sum_{\sigma_6\sigma_7}f^{\rm xc }_{\sigma_1\sigma_1\sigma_6\sigma_6}
	P_{\sigma_6\sigma_6\sigma_7\sigma_7}f^{\rm xc}_{\sigma_7\sigma_7\sigma_2\sigma_2},
	\label{eq:longlambda}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm c - \rm d}_{\sigma-\sigma\sigma-\sigma} = 4f^{\rm xc}_{\sigma-\sigma\sigma-\sigma} 
	+ 16 f^{\rm xc }_{\sigma-\sigma\sigma-\sigma}
	P_{\sigma-\sigma\sigma-\sigma}f^{\rm xc}_{\sigma-\sigma\sigma-\sigma},
	\label{eq:translambda}
\end{equation}
%
where $P$ indicates the proper part of the response function. The full response function can be obtained
by solving the following Dyson equation:
%
\begin{equation}
	\chi_{\sigma_1\sigma_2\sigma_3\sigma_4} = P_{\sigma_1\sigma_2\sigma_3\sigma_4}
	+ \delta_{\sigma_1\sigma_2}\delta_{\sigma_3\sigma_4} \sum_{\sigma\sigma'}
	P_{\sigma_1\sigma_2\sigma\sigma}v\chi_{\sigma'\sigma'\sigma_3\sigma_4},
	\label{eq:chiDyson}
\end{equation}
%
where $v$ indicates the bare Coulomb interaction.
The full response function in the spin basis describes how the spin-resolved charge density is modified
due to the external field:
%
\begin{equation}
	\chi_{\sigma_1\sigma_2\sigma_3\sigma_4}(\bm x_1,\bm x_2) \equiv
	\frac{\delta\rho_{\sigma_1\sigma_2}(\bm x_1)}{\delta\varphi^{\rm ext}_{\sigma_3\sigma_4}(\bm x_2)}.
	\label{eq:spinchi}
\end{equation}
%
In equations from (\ref{eq:Sigma11}) to (\ref{eq:Sigma21}), $\Lambda^{\rm c - \rm d}$ is still the
four-point function with respect to spin and difficult to handle.
To simplify these equations, we transform these four-point quantities into the quantities which have
two labels of the Pauli matrices; i.e.,
%
\begin{equation}
	\chi_{ij}(\bm x_1, \bm x_2) \equiv 
	\frac{\delta\rho_i(\bm x_1)}{\delta\varphi^{\rm ext}_{j}(\bm x_2)}.
	\label{eq:Paulichi}
\end{equation}
%
In this form, $\chi$ determines the change of the electronic charge $\rho$ or magnetic moment $\bm m$
due to the external physical fields.
The basis transformation between these two representations is defined as 
%
\begin{equation}
	\begin{split}
	& A_{\alpha\beta\delta\gamma} = \frac{1}{4}\sum_{ij}
	\sigma^{i}_{\alpha\beta}A_{ij}\sigma^{j}_{\gamma\delta}, \\
	& A_{ij} = \sum_{\alpha\beta\gamma\delta}
	\sigma^{i}_{\beta\alpha}A_{\alpha\beta\gamma\delta}\sigma^{i}_{\delta\gamma},
	\label{eq:basistrans}
\end{split}
\end{equation}
%
where $\sigma^{i}$ is the Pauli matrices
%
\begin{equation}
	\sigma^0 = 
	\begin{pmatrix}
		1 & 0 \\
		0 & 1
	\end{pmatrix},
	\sigma^x = 
	\begin{pmatrix}
		0 & 1 \\
		1 & 0
	\end{pmatrix},
	\sigma^y = 
	\begin{pmatrix}
		0 & -\rm i \\
		\rm i & 0
	\end{pmatrix},
	\sigma^z = 
	\begin{pmatrix}
		1 & 0 \\
		0 & -1
	\end{pmatrix}.
	\label{eq:Pauli}
\end{equation}
%
It should be noted that the full response function is sparse for the magnetic collinear system
%
\begin{equation}
	\chi_{ij} = 
	\begin{pmatrix}
		\chi_{xx} & \chi_{xy} & 0 & 0 \\
		\chi_{yx} & \chi_{yy} & 0 & 0 \\
		0 & 0 & \chi_{zz} & \chi_{z0} \\
		0 & 0 & \chi_{0z} & \chi_{00} \\
	\end{pmatrix},
	\label{eq:sparsechi}
\end{equation}
%
and the full response function is equal to the proper one, i.e., $\chi_{ij} = P_{ij}$ if 
$i, j \in \{x,y\}$.
Using these representations, we can rewrite the effective interaction $\Lambda^{\rm c - \rm d}$ in
more transparent form as follows
%
\begin{equation}
	\Lambda^{\rm c - \rm d}_{\sigma_1\sigma_1\sigma_2\sigma_2} = 
	\sum_{ij \in \{0,z\}} f^{\rm T}_{i\sigma_1}P_{ij}(1-\delta_{i0}\delta_{j0})f_{j\sigma_2},
	\label{eq:longlambdaafter}
\end{equation}
%
\begin{equation}
	\Lambda^{\rm c - \rm d}_{\sigma-\sigma\sigma-\sigma} = 
	2f^{\rm F}_{\sigma}\chi^{\rm F}_{\sigma}f^{\rm F}_{\sigma},
	\label{eq:translombdaafter}
\end{equation}
%
where the two-point funtions are defined as ($z_{\uparrow} = 1$,$z_{\downarrow} = -1$)
%
\begin{equation}
	\begin{split}
	&f^{\rm T}_{z\sigma} \equiv z_{\sigma}f^{\rm xc}_{zz} + f^{\rm xc}_{0z} \;\;\;
	f_{z\sigma} \equiv z_{\sigma}f^{\rm xc}_{zz} + f^{\rm xc}_{z0},\\
	&f^{\rm T}_{0\sigma} \equiv f^{\rm xc}_{00} + z_{\sigma}f^{\rm xc}_{z0} \;\;\;
	f_{0\sigma} \equiv f^{\rm xc}_{00} + z_{\sigma}f^{\rm xc}_{0z}, \\
	&f^{\rm F}_{\sigma} \equiv f^{\rm xc}_{xx} + z_{\sigma}{\rm i}f^{\rm xc}_{xy} \;\;\;
	\chi^{\rm F}_{\sigma} \equiv \chi_{xx} + z_{\sigma}\rm i \chi_{xy}.
	\label{eq:fdefine}
\end{split}
\end{equation}
%
In (\ref{eq:longlambdaafter}), we subtracted $f^{\rm xc}_{\sigma_1\sigma_1\sigma_2\sigma_2}+
f^{\rm T}_{0\sigma_1}P_{00}f_{0\sigma_2}$ in order to avoid the double counting.
In fact, this contribution is already included in the self-energy from the screened Coulomb interaction.
In addition, we neglected $f^{\rm xc}_{\sigma-\sigma\sigma-\sigma}$ in (\ref{eq:translombdaafter})
in order to avoid the physically unreasonable result. We will discuss this problem later.

So far we derived the two-point expression of the effective interaction $\Lambda^{\rm c - \rm d}$.
In addition, we make further two assumptions: The response functions and xc kernel $f^{\rm xc}$ are
diagonal with respect to the Pauli index and the effect of the external magnetic field is degenerated
in three directions. Within these assumptions, the effective interaction (\ref{eq:longlambdaafter}) and
(\ref{eq:translombdaafter}) can be written in simple form as follows:
%
\begin{equation}
	\begin{split}
	&\Lambda^{\rm c - \rm d}_{\sigma_1\sigma_1\sigma_2\sigma_2}(\bm x_1, \bm x_2) = 
	z_{\sigma_1}z_{\sigma_2}\Lambda^{\rm SF}(\bm x_1,\bm x_2), \\
	&\Lambda^{\rm c - \rm d}_{\sigma-\sigma\sigma-\sigma}(\bm x_1, \bm x_2) = 
	2\Lambda^{\rm SF}(\bm x_1,\bm x_2), \\
	&\Lambda^{\rm SF}(\bm x_1,\bm x_2) \equiv \iint d\bm x d\bm x'
	f^{\rm xc}_{zz}(\bm x_1,\bm x)\chi_{zz}(\bm x,\bm x')f^{\rm xc}_{zz}(\bm x',\bm x_2),
	\label{eq:finallambda}
\end{split}
\end{equation}
%
where $\chi_{zz}$ is the spin susceptibility which is obtained from the following equations
($m$ indicates the spin density)
%
\begin{equation}
	\chi_{zz}(\bm x,\bm x') = \chi^{\rm KS}(\bm x,\bm x') + 
	\iint d\bm x_1 d\bm x_2 \chi^{\rm KS}(\bm x, \bm x_1)f^{\rm xc}_{zz}(\bm x_1, \bm x_2)
	\chi_{zz}(\bm x_2,\bm x'),
	\label{eq:chis}
\end{equation}
%
\begin{equation}
	f^{\rm xc}_{zz}(\bm x,\bm x') = \frac{\delta^2 E_{\rm xc}}{\delta m(\bm x) \delta m(\bm x')}.
	\label{eq:fxcdef}
\end{equation}
%
Inserting (\ref{eq:finallambda}) into (\ref{eq:Sigma11}) to (\ref{eq:Sigma21}), we obtain the 
final form of the self-energy from spin fluctuations
%
\begin{equation}
	\bar{\Sigma}^{\rm SF}_{ab}(\bm x_1,\bm x_2) = 3(-1)^{a+b+1}
	\Lambda^{\rm SF}(\bm x_1, \bm x_2) \bar{G}_{ab}(\bm x_1, \bm x_2),
	\label{eq:SFselfenergy}
\end{equation}
%
where $a, b$ indicate the Nambu index.
The expression (\ref{eq:SFselfenergy}) has the GW form and then $\Lambda^{\rm SF}$ can be interpreted
as the effective interaction originated from the spin fluctuation.
The present form of the effective interaction reduces to the formalism by Vignale and Singwi\cite{Vignale1985} 
in the limit of a homogeneous electron gas and the similar form can be derived from the 
paramagnon-pole model\cite{Zhu1986}.
The xc kernel defined in (\ref{eq:fxcdef}) can be calculated using the Time-Dependent DFT(TDDFT)
\cite{Runge1984} within the ALDA.

\subsection{Kernel originated from spin fluctuations}
So far we have derived the spin fluctuations contribution to the self-energy in collinear superconductors.
Then we can consider the effect of spin fluctuations in the framework of SCDFT using the Sham-Schl\"{u}ter connection\cite{Sham1983,MarquesphD}.
The noninteracting Kohn-Sham system is mapped to the interacting system by the following self-energy
%
\begin{equation}
	\bar{\Sigma}^{\rm SS} = \bar{\Sigma}^{\rm GW} + \bar{\Sigma}^{\rm SF} + \bar{\Sigma}^{\rm ph}
	- 
	\begin{pmatrix}
		v_{\rm xc}  &   \Delta^{\rm xc}   \\
		\Delta^{\rm xc\ast}  &  -v_{\rm xc}
	\end{pmatrix}.
	\label{eq:SSself-energy}
\end{equation}
The Sham-Schl\"{u}ter connection is the requirement that the ground state densities of the Kohn-Sham
system and that of the interacting system should be same.
Because the normal density and the anomalous density is defined as 
%
\begin{equation}
	\rho(\bm r_1) = \lim_{\bm r_1 \to \bm r_2}
	\frac{2}{\beta}\sum_{\omega_n}G(\bm r_1,\bm r_2,\omega_n),
	\label{eq:normaldensity}
\end{equation}
%
\begin{equation}
	\chi(\bm r_1, \bm r_2) = \frac{1}{\beta}\sum_{\omega_n}F(\bm r_1, \bm r_2, -\omega_n),
	\label{eq:anomdensity}
\end{equation}
%
then the Sham-Schl\"{u}ter connection is written as follows:
%
\begin{equation}
	0 = \delta_{ab}\lim_{\bm r_1 \to \bm r_2} \frac{2}{\beta} 
	\sum_{\omega_n}e^{\rm i\omega_n0^{+}}[\bar{G}^{\rm KS}\bar{\Sigma}^{\rm SS}\bar{G}]_{ab},
	\label{eq:SSeqrho}
\end{equation}
%
\begin{equation}
	0 = (1-\delta_{ab})\frac{1}{\beta}\sum_{\omega_n}
	e^{\rm i\omega_n0^{+}}[\bar{G}^{\rm KS}\bar{\Sigma}^{\rm SS}\bar{G}]_{ab},
	\label{eq:SSeqanom}
\end{equation}
%
In order to handle these equations, we approximate the full Green's function with the Kohn-Sham
Green's function. Furthermore, we neglect all higher order term with respect to the xc potential
$\Delta^{\rm xc}$. The Matsubara summation in (\ref{eq:SSeqrho}) and (\ref{eq:SSeqanom}) can be
executed by means of the residue theorem:
%
\begin{equation}
	\frac{1}{\beta} \sum_{n}^{\infty}A(\rm i\omega_n) = 
	\sum_{m}^{{\rm Poles} \in \gamma} {\rm res}[f_{\beta}(z)A(z),z_{m}],
	\label{eq:residue}
\end{equation}
%
where $A(z)$ is an analytic function. After the Matsubara summation and some of algebra, we obtain
the gap equation which is similar to the conventional one (\ref{eq:truegapeq}):
%
\begin{equation}
	\Delta^{\rm xc}_{k} = -{\mathcal Z}_{k}\Delta^{\rm xc}_{k} - \frac{1}{2}
	\sum_{k'} {\mathcal K}_{kk'} \frac{\tanh[(\beta/2)E_{k'}]}
	{E_{k'}} \Delta^{\rm xc}_{k'},
	\label{eq:aftergapeq}
\end{equation}
%
\begin{equation}
	\mathcal Z_{k} = \mathcal Z^{\rm ph}_{k} - \mathcal Z^{\rm SF}_{k} 
	\label{eq:Zsum}
\end{equation}
%
\begin{equation}
	\begin{split}
	\mathcal Z^{\rm SF} &= - \frac{1}{\beta^2}\frac{2}{\tanh[(\beta/2)\xi_{k}]} 
	\sum_{n,m}\sum_{k'}\frac{1}{{\rm i}\omega_n + E_k}\frac{1}{{\rm i}\omega_m + E_{k'}}
	\left(\frac{1}{{\rm i}\omega_n + E_k} - \frac{1}{ {\rm i}\omega_n - E_{k'}} \right)\Lambda^{\rm SF}_{kk'}(\omega_n - \omega_m) \\
	&\quad + \frac{2}{\beta^2}\left(\frac{1}{\xi_k} - \frac{(\beta/2)}{\sinh[(\beta/2)\xi_k]\cosh[(\beta/2)\xi_k]} \right)
	\sum_{nm}\sum_{k'k''} \frac{1}{({\rm i}\omega_n + E_{k'})^2} \frac{1}{ {\rm i}\omega_m + E_{k''}}
	\frac{1}{\sum_{k'}\frac{\beta/2}{\cosh^2\left[(\beta/2)\xi_{k'}\right]}} \Lambda^{\rm SF}_{k'k''}(\omega_n - \omega_m),
	\label{eq:ZSFdef}
\end{split}
\end{equation}
%
\begin{equation}
	\mathcal K_{kk'} = \mathcal K^{\rm ph}_{kk'} + \mathcal K^{\rm el}_{kk'} + \mathcal K^{\rm SF}_{kk'}
	\label{eq:Ksum}
\end{equation}
%
\begin{equation}
	{\mathcal K}^{\rm SF}_{kk'} = 
	\lim_{\{\Delta_{k}\} \to 0}
	\frac{1}{\tanh[(\beta/2)E_{k}]}\frac{1}{\tanh[(\beta/2)E_{k'}]}
	\frac{1}{\beta^2}
	\sum_{\omega_n\omega_m}
	F_{k}({\rm i}\omega_n)F_{k'}({\rm i}\omega_m)
	\Lambda^{\rm SF}_{kk'}(\omega_n - \omega_m),
	\label{eq:KSFdef}
\end{equation}
%
\begin{equation}
	F_{k}({\rm i}\omega_n) = \frac{1}{ {\rm i}\omega_n + E_{k}} - 
	\frac{1}{ {\rm i}\omega_n - E_{k}}.
	\label{eq:Fkdef}
\end{equation}
%
In the above equations, $k = \{n,\bm k \}$ and the kernels labeled ph and el are same as ones
derived in the preivious section. Note that the contribution from spin fluctuations to $\mathcal Z$
has the different sign from phonon contribution, while in $\mathcal K$ they have same signs.
This sign difference comes from the number of loops contained in diagrams discussed above
(see (\ref{eq:Fself})). The detail of derivation of these equations are described in Appendix.
%%%%%%%%%%%%%%%%%%%%    Equation  %%%%%%%%%%%%%%%%%%%%%
\section{Equation}\label{sec:method_model}
\subsection{Equation}\label{sec:method_model_model}	
% equation
%  \begin{equation}  %%%%%%% Etot =
%   E_{\rm{total}}(u_m,e_i)=E_0 + E_{\rm{phonon}}(u_m) + E_{\rm{spin}}(u_m,e_i).
%\end{equation} 


\section{Figure}\label{sec:method_parameters}



%%%%%%%%%%%%%%%%%%%%% Figure %%%%%%%%%%%%%%%%%%%%%i%
%\subsection{Figure}
%FIGURE
%\begin{figure} %%%%%%% FIGURE 4state-mapping
%	\centering
%	\includegraphics[width=14truecm,clip]{../figure/method/4statemapping.eps}
%	\caption{The four different spin configurations   \label{fig:4states}}
%\end{figure}
%
%\begin{figure}[h]
% \begin{minipage}[b]{0.4\linewidth}
%  \centering
%     \subcaption{}
%  \includegraphics[keepaspectratio, scale=0.2]
%  {../figure/method/CoPt_2.eps}
% \end{minipage}
%  \begin{minipage}[b]{0.6\linewidth}
%  \centering
%    \subcaption{}
%  \includegraphics[keepaspectratio, scale=0.6]
%  {../figure/method/CoPt_mae_2.eps}
%   \end{minipage}
% \caption{(a) The unit cell of CoPt.  (b) Magnetic anisotropic energy of CoPt. }\label{fig:structure_copt}
%\end{figure}
%
%
\include{end}
